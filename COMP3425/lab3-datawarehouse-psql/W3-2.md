

# W3-2: Exercises for Analysing Data in Warehouses
Use `\dt` to show tables,  and don't forget to terminate all your SQL  queries with a `;` .Use `f` to page through results and q  to quit the pager.

`dt+` for more information.

The tables are `counties` and `population` in this lab.
```SQL
CREATE TABLE counties   (county_id int,
			 region integer CHECK (0 < region) CHECK (region < 5),
			 division integer CHECK (0 < division) CHECK (division < 10),
			 state varchar, 
			 county varchar, 
			 PRIMARY KEY (county_id));

CREATE TABLE population (county_id int REFERENCES counties (county_id),
			 year smallint CHECK (2009 < year) CHECK (year < 2017), 
			 eoy_population int CHECK (eoy_population >= 0), 
			 births integer CHECK (births >= 0), 
			 deaths integer CHECK (deaths >= 0), 
			 international_migration integer, 
			 domestic_migration integer, 
			 residual int,
			 PRIMARY KEY (county_id, year));
```

# 1. Aggregation (Roll-Up by dimension reduction) and Cubes

## (2)
`population::  county_id | year | eoy_population | births | deaths | international_migration | domestic_migration | residual`

`counties::  county_id | region | division |        state         |              county`

## (3)
`SELECT year, SUM(births), COUNT(*) FROM population GROUP BY ROLLUP (year);`
```SQL
 year |   sum    | count 
------+----------+-------
      | 24743884 | 21987
 2015 |  3980206 |  3141
 2011 |  3970100 |  3141
 2014 |  3960262 |  3141
 2010 |   987086 |  3141
 2016 |  3974891 |  3141
 2012 |  3933831 |  3141
 2013 |  3937508 |  3141
```
Number of rows = 8 (`SELECT COUNT(*) FROM (SELECT year, SUM(births), COUNT(*) FROM population GROUP BY ROLLUP (year)) as foo;`)
Hey look, it gave us the apex cube. 

## (4)
`SELECT county_id, SUM(births), COUNT(*) FROM population GROUP BY ROLLUP (county_id);`
```SQL
 county_id |   sum    | count 
-----------+----------+-------
           | 24743884 | 21987
       790 |      290 |     7
      2850 |      913 |     7
      1798 |     2437 |     7
      1489 |     1187 |     7
      2335 |     1374 |     7
      1269 |    19620 |     7
... etc
```

Number of rows = 3142 (`SELECT COUNT(*) FROM (SELECT county_id, SUM(births), COUNT(*) FROM population GROUP BY ROLLUP (county_id)) as foo;`)


## (5)
`SELECT county_id, year, SUM(births), COUNT(*) FROM population GROUP BY CUBE (county_id, year);`

Number of rows = 25136 (not 25144...?) (`SELECT COUNT(*) FROM (SELECT county_id, year, SUM(births), COUNT(*) FROM population GROUP BY CUBE (county_id, year)) as foo;`)

Number of rows in `population`: 21987 (`SELECT COUNT(*) FROM population;`)

25136 = 1 + 21987 + (8 - 1) + (3142 - 1)

## (6)

The apex cube contains two columns, the SUM of births and COUNT of the rows contributing to that row. The former refers to the total sum of births occurring over all countries over all years. The count refers to the number of rows contributing to that sum, which is equivalent to all the rows in the original, unaggregated table (21987)

# 2. Rollup by climbing up the concept hierarchy, and materialising cubes

Fix: You're only moving along the concept hierarchy, therefore you were not meant to get rid of the year dimension!

county_level: `SELECT * INTO county_level FROM (SELECT county_id, county, state, division, region, year, SUM(births - deaths) as net_nat_change, SUM(domestic_migration + international_migration) as net_migration FROM population NATURAL JOIN counties) as foo ORDER BY county_id;`


state_level: `SELECT * INTO state_level FROM (SELECT state, division, region, year, SUM(net_nat_change) as net_nat_change, SUM(net_migration) as net_migration FROM county_level GROUP BY state, division, region, year) as foo ORDER BY state;`

division_level: `SELECT * INTO division_level FROM (SELECT division, region, year, SUM(net_nat_change) as net_nat_change, SUM(net_migration) as net_migration FROM state_level GROUP BY division, region, year) as foo ORDER BY division;`


region_level: `SELECT * INTO region_level FROM (SELECT region, year, SUM(net_nat_change) as net_nat_change, SUM(net_migration, year) as net_migration FROM division_level GROUP BY region) as foo ORDER BY region;`

Okay, I can't be bothered to rewrite the above.

# 3. Querying the Cubes
## (1)
`SELECT AVG(net_migration) FROM state_level WHERE year=2015;`

## (2)
Didn't do this one, because I'm dumb.

This is the provided answer: `SELECT division, net_migration, net_natural FROM new_population_division WHERE year = 2013 AND net_migration > net_natural;`

# 4. Strategy for querying
## (1)

Use the division level. (Correct, BTW)

## (2)

Unfinished. 